@inherits LayoutComponentBase
@using AircraftStateCore.Models;
@using AircraftStateCore.Services.Interfaces;

@inject IDialogService DialogService
@inject ISimConnectService simconnect

@* Required *@

@* <MudThemeProvider @bind-IsDarkMode="@_isDarkMode" /> TODO: Reseach Themes *@  
<MudThemeProvider />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-2">
            @if (simconnect.VerifyAutoSave())
            {
                <div class="col-6 col-sm-4 col-md-3 col-lg-auto"><Badge IsPill="true" Color="BootstrapBlazor.Components.Color.Info">Autosave enabled</Badge></div>
            }
            @if (@simconnect.Connected())
            {
                <div class="col-6 col-sm-4 col-md-3 col-lg-auto"><Badge IsPill="true" Color="BootstrapBlazor.Components.Color.Success">Connected to Sim</Badge></div>
            }
            else
            {
                <div class="col-6 col-sm-4 col-md-3 col-lg-auto"><Badge IsPill="true" Color="BootstrapBlazor.Components.Color.Danger">Not Connected to Sim</Badge></div>
            }
            @*<a href="https://docs.microsoft.com/aspnet/" target="_blank">about</a>*@
        </div>

        <article class="content px-4">
        <MudLayout>
            <MudMainContent>
            @Body
            </MudMainContent>
        </MudLayout>
        </article>
    </main>
</div>

@code
{
    private String Message { get; set; }

    protected override void OnInitialized()
    {
        simconnect.OnMessageUpdate += Refresh;
    }

    private async Task ShowDialog()
    {
        var param = new DialogParameters<DialogOk> {
            { x => x.Message, "Save current data to the database?" },
            { x => x.ShowCancel, true }
        };
        var dialogReference = await DialogService.ShowAsync<DialogOk>("Save Data", param);
        var result = await dialogReference.Result; // Await the result of the dialog
    }

    private async Task Refresh()
    {
        Message = simconnect.DisplayMessage;
        if (!string.IsNullOrEmpty(Message))
        {
            var param = new DialogParameters<DialogOk> {
                { x => x.Title, "Save Data" },
                { x => x.Message, Message }
            };

            await DialogService.ShowAsync<DialogOk>(String.Empty, param);
            simconnect.DisplayMessage = string.Empty;
        }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        simconnect.OnMessageUpdate -= Refresh;
    }
}